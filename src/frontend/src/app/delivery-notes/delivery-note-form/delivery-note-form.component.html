<div class="page-header">
  <h1 class="page-title">{{ id ? 'İrsaliye Düzenle' : 'Yeni İrsaliye' }}</h1>
  <a routerLink="/delivery-notes" class="btn btn-default">← Geri</a>
</div>
<div class="card">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="form-section">
      <div class="form-grid">
        @if (id && deliveryNumber) {
          <div class="row">
            <label>İrsaliye no</label>
            <span class="form-readonly">{{ deliveryNumber }}</span>
          </div>
        }
        <div class="row" #customerDropdownWrap>
          <label>Cari</label>
          <div class="customer-select">
            <button type="button" class="customer-select-trigger" (click)="toggleCustomerDropdown(); $event.stopPropagation()">
              {{ selectedCustomerTitle }}
            </button>
            @if (customerDropdownOpen) {
              <div class="customer-select-panel">
                <input type="text" class="customer-search" placeholder="Cari ara..." [value]="customerSearchText" (input)="customerSearchText = $any($event.target).value" />
                <div class="customer-options-list">
                  <button type="button" class="customer-option" (click)="selectCustomer(null)">Seçiniz</button>
                  @for (c of filteredCustomers; track c.id) {
                    <button type="button" class="customer-option" (click)="selectCustomer(c)">{{ c.title }}</button>
                  }
                  @if (filteredCustomers.length === 0 && customerSearchText) {
                    <div class="customer-option empty">Sonuç bulunamadı</div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
        <div class="row">
          <label>İrsaliye Tarihi</label>
          <input type="datetime-local" formControlName="deliveryDate" />
        </div>
        @if (!id) {
          <div class="row">
            <label>Tip</label>
            <select formControlName="deliveryType">
              <option [ngValue]="0">Satış</option>
              <option [ngValue]="1">Alış</option>
            </select>
          </div>
        }
        @if (id) {
          <div class="row">
            <label>Durum</label>
            <span class="form-readonly">{{ statusLabel(deliveryStatus) }}</span>
          </div>
        }
      </div>
    </div>
    <div class="form-section items-section">
      <h3>Kalemler</h3>
      <div class="filter-row">
        <input type="text" [(ngModel)]="productFilterText" placeholder="Ürün ara (kod veya ad)..." class="product-filter" [ngModelOptions]="{standalone: true}" />
      </div>
      <div class="item-header">
        <span class="item-col-product">Ürün</span>
        <span class="item-col-desc">Açıklama</span>
        <span class="item-col-qty">Miktar</span>
        <span class="item-col-price">Birim Fiyat</span>
        <span class="item-col-vat">KDV %</span>
        <span class="item-col-action"></span>
      </div>
      <div formArrayName="items">
        @for (item of items.controls; track item; let i = $index) {
          <div [formGroupName]="i" class="item-row">
            <select formControlName="productId" (change)="onProductSelect(i)">
              <option [ngValue]="null">—</option>
              @for (p of filteredProducts; track p.id) {
                <option [ngValue]="p.id">{{ p.code }} - {{ p.name }}</option>
              }
            </select>
            <input formControlName="description" placeholder="Ürün/hizmet açıklaması" />
            <input type="number" formControlName="quantity" placeholder="Adet" min="0" step="1" />
            <input type="number" formControlName="unitPrice" placeholder="0" min="0" step="0.01" />
            <input type="number" formControlName="vatRate" placeholder="18" min="0" max="100" step="1" />
            <button type="button" (click)="removeItem(i)">Sil</button>
          </div>
        }
      </div>
      <button type="button" class="add-item-btn" (click)="addItem()">+ Kalem Ekle</button>
    </div>
    @if (error) { <p class="error-msg">{{ error }}</p> }
    <div class="actions">
      <button type="submit" [disabled]="form.invalid || saving">Kaydet</button>
      <a [routerLink]="id ? ['/delivery-notes', id] : ['/delivery-notes']">İptal</a>
    </div>
  </form>
</div>
