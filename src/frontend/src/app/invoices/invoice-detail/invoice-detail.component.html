@if (invoice) {
<div class="page-header">
  <div class="page-header-left">
    <h1 class="page-title">Fatura {{ invoice.invoiceNumber }}</h1>
    <div class="meta">
      <span>Tarih: {{ invoice.invoiceDate | date:'dd.MM.yyyy HH:mm' }}</span>
      <span class="status-badge {{ statusClass(invoice.status) }}">{{ statusLabel(invoice.status, invoice.sourceType)
        }}</span>
      <span>Cari: {{ invoice.customerTitle }}</span>
      @if (invoice.sourceType === 'Irsaliye' && invoice.sourceId && invoice.sourceNumber) {
      <span class="source">İrsaliye No: {{ invoice.sourceNumber }}</span>
      }
    </div>
  </div>
  <div style="display: flex; gap: 8px;">
    @if (invoice.sourceType === 'Irsaliye' && invoice.sourceId) {
    <a [routerLink]="['/delivery-notes', invoice.sourceId]" class="back-link" style="color: inherit;">İrsaliyeye
      Git</a>
    }
    <a routerLink="/invoices" class="back-link">← Geri</a>
  </div>
</div>
<div class="card table-wrap">
  <table>
    <thead>
      <tr>
        <th>Stok Kodu</th>
        <th>Mal Hizmet</th>
        <th>Miktar</th>
        <th>Birim Fiyat</th>
        <th>KDV Oranı</th>
        <th>KDV Tutarı</th>
        <th>Mal Hizmet Tutarı</th>
      </tr>
    </thead>
    <tbody>
      @for (item of invoice.items; track item.sortOrder) {
      <tr>
        <td>{{ item.productCode || '—' }}</td>
        <td>{{ item.description }}</td>
        <td>{{ item.quantity | number }}</td>
        <td>{{ item.unitPrice | number:'1.2-2' }} ₺</td>
        <td>%{{ item.vatRate }}</td>
        <td>{{ item.lineVatAmount | number:'1.2-2' }} ₺</td>
        <td>{{ item.lineTotalInclVat | number:'1.2-2' }} ₺</td>
      </tr>
      }
    </tbody>
  </table>
  <div class="totals">
    <p><span>Mal Hizmet Toplam Tutarı</span> <span>{{ invoice.subTotal | number:'1.2-2' }} {{ invoice.currency }}</span>
    </p>
    <p><span>Hesaplanan KDV</span> <span>{{ invoice.totalVat | number:'1.2-2' }} {{ invoice.currency }}</span></p>
    <p class="grand-total"><span>Genel Toplam</span> <span>{{ invoice.grandTotal | number:'1.2-2' }} {{ invoice.currency
        }}</span></p>
  </div>
</div>
<div class="actions">
  @if (invoice.status === 0) {
  <a [routerLink]="['/invoices', invoice.id, 'edit']" class="btn btn-secondary">Düzenle</a>
  }

  @if (!invoice.isGibSent) {
  <button type="button" class="btn btn-primary" (click)="sendToGib()" [disabled]="sendingGib">
    {{ sendingGib ? 'Gönderiliyor...' : 'GİB\'e Gönder' }}
  </button>
  <span class="text-muted" style="margin-right: 15px; font-size: 0.9em;">
    * Faturayı PDF olarak indirebilmek için önce GİB'e göndermelisiniz.
  </span>
  } @else {
  <button type="button" class="btn btn-primary" (click)="downloadPdf()">PDF İndir</button>
  }
</div>
} @else {
<p class="loading">Yükleniyor...</p>
}