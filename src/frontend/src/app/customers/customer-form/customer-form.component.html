<div class="page-header">
  <h1 class="page-title">{{ id ? 'Cari Düzenle' : 'Yeni Cari' }}</h1>
</div>
<div class="card">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="form-grid">
      <div class="row">
        <label>Ana cari kodu</label>
        <div class="input-with-link main-account-combo" (click)="$event.stopPropagation()">
          <div class="combo-wrap">
            @if (selectedMainAccount) {
              <span class="selected-label">{{ selectedMainAccount.code }} — {{ selectedMainAccount.name }}</span>
              <button type="button" class="btn-clear" (click)="clearMainAccountCode()" title="Seçimi temizle">×</button>
            } @else {
              <input
                type="text"
                [(ngModel)]="mainAccountCodeSearch"
                [ngModelOptions]="{standalone: true}"
                placeholder="Kod veya ad ile ara, listeden seçin"
                (focus)="showMainAccountDropdown = true"
                (keydown.escape)="showMainAccountDropdown = false"
              />
            }
          </div>
          @if (showMainAccountDropdown && !selectedMainAccount) {
            <ul class="combo-dropdown" (click)="$event.stopPropagation()">
              @for (item of filteredMainAccountCodes; track item.id) {
                <li (click)="selectMainAccountCode(item)">{{ item.code }} — {{ item.name }}</li>
              }
              @if (filteredMainAccountCodes.length === 0) {
                <li class="no-results">Sonuç yok. Kod listesinden ekleyebilirsiniz.</li>
              }
            </ul>
          }
          <a routerLink="/main-account-codes" class="link-small">Kod listesini düzenle</a>
        </div>
      </div>
      <div class="row">
        <label>Cari kodu</label>
        <input formControlName="code" placeholder="Örn. A01, S01" />
      </div>
      <div class="row">
        <label>Cari adı</label>
        <input formControlName="title" placeholder="Cari adı" />
      </div>
      <div class="row">
        <label>Mükellef türü</label>
        <select formControlName="taxPayerType">
          <option [ngValue]="1">Gerçek kişi</option>
          <option [ngValue]="2">Tüzel kişi</option>
        </select>
      </div>
      <div class="row">
        <label>Cari tipi</label>
        <select formControlName="cardType">
          <option [ngValue]="1">Alıcı</option>
          <option [ngValue]="2">Satıcı</option>
        </select>
      </div>
      <div class="row">
        <label>Vergi No / TC</label>
        <input formControlName="taxNumber" placeholder="10 veya 11 haneli" />
        @if (form.get('taxNumber')?.invalid && form.get('taxNumber')?.touched) {
          <span class="error-msg">{{ form.get('taxNumber')?.errors?.['taxNumber'] }}</span>
        }
      </div>
      <div class="row full-width">
        <label>Adres</label>
        <input formControlName="address" placeholder="Tam adres" />
      </div>
      <div class="row">
        <label>İl</label>
        <input formControlName="city" placeholder="Şehir" />
      </div>
      <div class="row">
        <label>İlçe</label>
        <input formControlName="district" placeholder="İlçe" />
      </div>
      <div class="row">
        <label>Posta kodu</label>
        <input formControlName="postalCode" placeholder="Posta kodu" />
      </div>
      <div class="row">
        <label>Ülke</label>
        <input formControlName="country" placeholder="Ülke" />
      </div>
      <div class="row">
        <label>Telefon</label>
        <input formControlName="phone" placeholder="0xxx xxx xx xx" />
      </div>
      <div class="row">
        <label>E-posta</label>
        <input type="email" formControlName="email" placeholder="cari@ornek.com" />
      </div>
      @if (error) { <p class="error-msg">{{ error }}</p> }
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="button" (click)="onSubmit()" [disabled]="saving">Kaydet</button>
      <a routerLink="/customers">İptal</a>
    </div>
  </form>
</div>
